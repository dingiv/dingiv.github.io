# 总线协议


## 硬件行为
+ 设备探测：操作系统识别系统中存在硬件设备的过程，通过扫描总线来发现设备，支持热插拔特性，即支持动态探测；
+ 设备枚举：为设备分配总线唯一标识（如地址、设备号），使其可被操作系统和驱动使用，一般是设备探测后的进一步过程；
+ 资源配置：设置设备寄存器、分配资源，通常在设备枚举完成后，由总线驱动或内核在设备初始化（probe 阶段）时执行，包括：
  + 中断号（IRQ）
  + 内存映射 I/O（MMIO）地址
  + I/O 端口
  + DMA 通道
+ 设备拔出：总线设备支持热插拔，即在操作系统不重启的情况下，动态添加和移除硬件设备；
+ 电源管理：控制设备电源状态，使得设备进入休眠状态；
+ 数据传输：设备成功配置，设备进入工作阶段，通过驱动程序中的数据传输函数进行数据读写数据；
+ 中断处理：主要用于监听硬件事件，实现硬件级别的异步回调机制，包括数据接收、DMA 功能、错误处理等；


## 总线协议
不同的设备通过各自的总线挂载到系统上，总线协议定义了硬件设备与 CPU、内存之间的通信规则，包括数据传输、设备发现、资源分配等生命周期的内容。这是硬件层面的内容，但它也提示了操作系统，应当以怎样的逻辑来管理这个总线上的硬件。

目前的硬件总线主要包括：PCI、USB、I2S 等，对于部分设备无挂载总线，使用自定义的方式进行注册；

## 生命周期
+ 设备发现
+ 资源分配
+ 数据传输

## PCI

## USB


## I2C



### 1. **总线**
**定义**: 总线是 Linux 内核中用于连接和管理硬件设备与 CPU 的抽象模型，负责设备发现、资源分配和驱动绑定。常见总线包括 PCI/PCIe、USB、I2C、SPI、Platform等。

**核心功能**:
- **设备发现**:
  - 扫描硬件设备，识别设备 ID（如 PCI 的 Vendor/Device ID）。
  - 例: PCI 总线扫描设备：
    ```c
    struct pci_dev *dev = pci_get_device(vendor, device, NULL);
    ```
- **资源管理**:
  - 分配 IRQ、MMIO 地址、I/O 端口等。
  - 例: 查看 PCI 资源：
    ```bash
    lspci -v
    ```
    输出：
    ```
    Region 0: Memory at fe900000 (64-bit, non-prefetchable) [size=1M]
    ```
- **驱动绑定**:
  - 匹配设备与驱动，调用驱动的 `probe` 函数。
- **层次结构**:
  - 设备通过 `struct device` 组织为树状结构，父节点为总线或控制器。

**常见总线**:
- **PCI/PCIe**: 高性能设备（如网卡、GPU）。
- **USB**: 外设（如键盘、U盘）。
- **I2C/SPI**: 嵌入式低速设备（如传感器、EEPROM）。
- **Platform**: 非标准总线设备（如 SoC 集成外设）。

---

### 2. **总线驱动**
**定义**: 总线驱动是内核模块，管理特定总线类型的设备探测、资源分配和驱动匹配，基于 Linux 设备模型（`struct bus_type`）实现。

**核心组件**:
- **struct bus_type**:
  - 定义总线类型，包含匹配和探测逻辑。
  - 例: PCI 总线定义：
    ```c
    struct bus_type pci_bus_type = {
        .name = "pci",
        .match = pci_bus_match,
        .probe = pci_device_probe,
    };
    ```
- **struct device**:
  - 表示总线上的设备，包含资源信息（如 MMIO 地址、IRQ）。
- **struct device_driver**:
  - 表示驱动，定义 `probe`、`remove` 等操作。
  - 例: PCI 驱动：
    ```c
    struct pci_driver my_driver = {
        .name = "my_driver",
        .id_table = my_id_table,
        .probe = my_probe,
    };
    ```

**工作机制**:
1. **设备探测**:
   - 总线驱动扫描硬件（如 PCI 枚举），创建 `struct device`。
   - 例: PCI 枚举：
     ```c
     pci_register_driver(&my_driver);
     ```
2. **驱动匹配**:
   - 总线通过 `bus_type.match` 比较设备 ID 和驱动的 `id_table`。
   - 例: PCI ID 表：
     ```c
     static const struct pci_device_id my_id_table[] = {
         { PCI_DEVICE(0x8086, 0x1234) },
         { 0, }
     };
     ```
3. **资源分配**:
   - 分配 IRQ、MMIO 地址等，存储在 `struct resource`。
   - 例: 请求 MMIO：
     ```c
     request_mem_region(0xfe900000, 0x1000, "my_device");
     ```
4. **驱动绑定**:
   - 调用驱动的 `probe` 函数初始化设备。
   - 例:
     ```c
     static int my_probe(struct pci_dev *dev, const struct pci_device_id *id) {
         return 0;
     }
     ```

**典型需求**:
- 实现新总线驱动（如自定义 SoC 总线）。
- 支持热插拔（如 USB 设备插入）。
- 优化资源分配（如 DMA 通道）。

---

### 3. **总线与总线驱动的关系**
- **总线**:
  - 提供硬件连接和通信协议（如 PCI 的 BAR 寄存器）。
  - 定义设备模型的层次结构（`/sys/bus`）。
- **总线驱动**:
  - 实现总线协议，管理设备发现、资源分配和驱动绑定。
  - 通过 `sysfs` 暴露设备信息，供 udev 使用。
  - 例: 查看 USB 设备：
    ```bash
    ls /sys/bus/usb/devices
    ```

---

### 4. **总结**
- **总线**: 硬件与内核的连接抽象，负责设备发现、资源管理和层次组织。
- **总线驱动**: 内核模块，实现总线协议，管理设备探测、驱动匹配和资源分配。
- **关系**: 总线定义硬件接口，总线驱动实现内核管理，与设备模型和 udev 协作。

如果你想深入某总线（如 PCI 的枚举流程、SPI 驱动实现）或需要代码示例、图表，请告诉我！



## IO 管理

IO 设备拥有独立的控制处理器，现代 IO 设备通过 MMIO 方式将自身寄存器地址空间映射到物理内存空间中，让 CPU 通过直接读写物理地址空间来控制 IO 设备。

### 设备挂载

1. 设备识别和驱动加载

   - 识别设备：操作系统检测设备并分配设备文件（Linux 中通常位于`/dev/`目录下）
   - 加载驱动：操作系统加载适当的驱动程序支持设备操作

2. 设备格式化

   - 存储设备需要经过格式化才能使用
   - 格式化将物理存储空间划分为存储区域
   - 为这些区域建立文件系统
   - 未格式化的存储设备不能直接存储文件和数据

   文件系统格式化：

   - 文件系统是操作系统管理磁盘上文件的方式
   - 不同操作系统使用不同的文件系统格式（ext4、NTFS、FAT32、exFAT 等）
   - 分区表（MBR 或 GPT）定义设备上不同部分的布局和大小

   例如，在 Linux 中格式化磁盘分区：

   ```bash
   sudo mkfs.ext4 /dev/sda1
   ```

3. 挂载存储设备

   - 格式化后，存储设备的文件系统才可用
   - 挂载操作将设备上的文件系统与操作系统的目录结构连接
   - 用户可以通过路径访问存储设备的内容

   在 Linux 中挂载设备：

   ```bash
   sudo mount /dev/sda1 /mnt
   ```

4. 文件系统检查与修复

   - 文件系统可能因突然断电或设备损坏而不一致
   - 操作系统执行文件系统检查（fsck）修复问题

   在 Linux 中手动运行文件系统检查：

   ```bash
   sudo fsck /dev/sda1
   ```

5. 挂载配置（可选）

   - 可以将存储设备配置为系统启动时自动挂载
   - 通过编辑`/etc/fstab`文件完成配置

   例如，添加以下行将设备`/dev/sda1`挂载到`/mnt`：

   ```bash
   /dev/sda1 /mnt ext4 defaults 0 2
   ```
